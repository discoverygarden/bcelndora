
# SimpleSAMLphp SAML Setup Guide

## Overview


This guide explains how to configure SimpleSAMLphp for a Drupal Helm deployment, using AWS IAM Identity Center (AWS SSO) as a SAML provider and supporting additional customer SAML IdPs.

**Audience:**
- **dgi**: Responsible for AWS IAM Identity Center (AWS SSO) setup steps.
- **BCELN**: Responsible for configuration steps in Helm and providing required SAML IdP information.

---


## 1. AWS IAM Identity Center (AWS SSO) as SAML Provider

### A. AWS Console Setup (**dgi responsibility**)

1. **Create an Application:**
   - dgi will go to AWS IAM Identity Center > Applications.
   - Add a new application and choose "Custom SAML 2.0 application".
   - Download the AWS-provided SAML metadata XML.

2. **Configure Assertion Attributes:**
   - dgi ensures the application sends required attributes (e.g., NameID, email) that Drupal expects.

3. **Get the AWS SAML Metadata:**
   - dgi will provide the metadata XML for your SimpleSAMLphp config.

### B. Helm Configuration (**BCELN responsibility**)

Add an entry under `simplesaml.authSources` for AWS IAM (example: `dgi`):


```yaml
simplesaml:
  authSources:
    dgi:
      entityId: https://portal.sso.us-east-1.amazonaws.com/saml/assertion/ODM5Mzk3NjU3ODcwX2lucy1hMmM5NjFhZDFmZjUwY2M1
      metadata: |
        <?xml version="1.0" encoding="UTF-8"?><md:EntityDescriptor ...>...</md:EntityDescriptor>
      signing:
        secret:
          certKey: cert
          keyKey: key
          secretName: simplesaml-cert
      type: saml:SP
```


- **entityId**: The AWS IAM SAML application’s entity ID (provided by dgi).
- **metadata**: Paste the AWS SAML metadata XML here (provided by dgi).
- **signing.secret**: Reference to a Kubernetes secret containing your SP’s certificate and key (BCELN responsibility).

---


## 2. Adding a BCELN SAML IdP

### A. What BCELN Needs to Provide

- Your SAML metadata XML (from your IT/Security team or IdP admin).
- Required attributes (e.g., NameID, email, groups) that your application expects.
- A test user account (optional, for validation).

### B. What dgi Provides to the Customer

- **Your SP metadata**: Generated by SimpleSAMLphp, available at  
  `https://<your-site>/simplesaml/module.php/saml/sp/metadata.php/<source>`
- **ACS (Assertion Consumer Service) URL**:  
  `https://<your-site>/simplesaml/module.php/saml/sp/saml2-acs.php/<source>`
- **EntityID**: The value you set for your SP in SimpleSAMLphp.

### C. Helm Configuration (**BCELN responsibility**)

Add a new entry under `simplesaml.authSources` for your IdP (example: `bu`):


```yaml
simplesaml:
  authSources:
    bu:
      entityId: https://shib.bu.edu/idp/shibboleth
      metadata: |
        <EntityDescriptor ...>...</EntityDescriptor>
      signing:
        secret:
          certKey: cert
          keyKey: key
          secretName: simplesaml-cert
      type: saml:SP
```

---


## 3. Multi-Auth Setup

To allow users to choose between multiple IdPs (e.g., AWS IAM or a BCELN IdP):


```yaml
simplesaml:
  authSources:
    multi:
      sources:
        bu:
          displayText: Login for Boston University
        dgi:
          displayText: Login for dgi staff
      type: multiauth:MultiAuth
```

---


## 4. Certificates

- Store your SP’s certificate and key in a Kubernetes secret (e.g., `simplesaml-cert`). (BCELN responsibility)
- Reference the secret in each `signing.secret.secretName`.

---


## 6. Summary Table

| What BCELN provides to dgi        | What dgi provides to BCELN                |
|-----------------------------------|-------------------------------------------|
| SAML metadata XML                 | SP metadata XML (contains ACS URL, EntityID, etc.) |
| Required attributes               |                                           |
| Test user (optional)              |                                           |

---


## 7. Testing

- Deploy your Helm chart. (BCELN responsibility)
- Test login via each configured IdP.

---